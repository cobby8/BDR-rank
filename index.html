/** =====================================================================
 * BDR Ranking Backend (Team-Only, D3~D7 + Teams/Group + rankMove) v2.2.0
 *
 * ✅ 포함 기능
 * - Router: doGet/doPost + path 파라미터
 * - 모든 응답 JSON 통일(에러도 JSON)
 * - 시트 보장/마이그레이션:
 *    ensureSheets_(), ensureResultsHeader_(), ensureTeamsHeader_(), ensureIdsForResults_()
 * - 랭킹 계산 공식(시간가치: Y-0=1, Y-1=0.5, Y-2=0.25, Y-3=0[소멸])
 * - Settings 덮어쓰기: BASE_POINTS / DIV_WEIGHT / TIME_WEIGHT / SIZE_RULE
 * - Division 별칭 매핑: 동호회 최강전/챌린저스/비기너스/뉴비/스타터스 → D3~D7
 * - Teams 조인: city, group('d' 일반부 | 'u' 대학부), logoUrl(선택)
 * - TeamRank 확장 컬럼: city, group, rankMove(이전 랭킹 대비 +상승/-하락/0유지)
 *   · prevRank는 이전 TeamRank의 prevPoints로 그룹별 정렬하여 계산
 * - TeamRankHistory: 스냅샷 저장(snapshotAt, teamName, totalPoints, group)
 * - GET: health, leaderboard(팀; group=d|u 필터/랭킹 포함), results 조회
 * - POST: upsertResults(배열), removeResults(by id), recompute
 * - 메뉴: [BDR Ranking ▸ 재계산/헤더정렬/셀프테스트]
 * - Cache: 그룹별 캐시 5분
 * ===================================================================== */

const VERSION = 'BDR-Ranking TeamOnly v2.2.0';

const CONF = {
  SHEET_ID   : '', // 바인드형이면 비워두기. 독립형이면 시트 ID 입력.
  TZ         : Session.getScriptTimeZone() || 'Asia/Seoul',

  TAB_SETTINGS : 'Settings',
  TAB_RESULTS  : 'Results',
  TAB_TEAMS    : 'Teams',
  TAB_TEAM_R   : 'TeamRank',
  TAB_TRHIST   : 'TeamRankHistory',

  CACHE_TTL_SEC: 300,  // 리더보드 캐시 5분
};

// 기본 상수(설정 없을 때)
const DEFAULT_BASE_POINTS = { '우승':100, '준우승':70, '4강':50, '8강':25, '참가':10 };
const DEFAULT_DIV_WEIGHTS = { D3:1.0, D4:0.75, D5:0.5, D6:0.25, D7:0.1 };
// 시간가치: Y-3=0(소멸)
const DEFAULT_TIME_WEIGHTS = { 'Y-0':1.0, 'Y-1':0.5, 'Y-2':0.25, 'Y-3':0.0 };
// 기본 대회규모 룰(우선순위 위에서 아래로 적용)
const DEFAULT_SIZE_RULES = [
  { op:'>=', n:24, w:1.5 },
  { op:'range', a:13, b:23, w:1.25 },
  { op:'=', n:12, w:1.0 },
  { op:'<=', n:11, w:0.5 },
];
// BDR 명칭 → 디비전 코드
const NAME_TO_DIV = { '동호회 최강전':'D3', '챌린저스':'D4', '비기너스':'D5', '뉴비':'D6', '스타터스':'D7' };

// ------------------ Utilities ------------------
function _ss(){
  return CONF.SHEET_ID ? SpreadsheetApp.openById(CONF.SHEET_ID) : SpreadsheetApp.getActiveSpreadsheet();
}
function _getSheet(name){ return _ss().getSheetByName(name); }
function _ensureSheet(name){ return _getSheet(name) || _ss().insertSheet(name); }
function _nowISO(){ return Utilities.formatDate(new Date(), CONF.TZ, "yyyy-MM-dd'T'HH:mm:ssXXX"); }
function _dateISO(d){
  if(!(d instanceof Date)) d = new Date(d);
  if(isNaN(d)) return '';
  return Utilities.formatDate(d, CONF.TZ, 'yyyy-MM-dd');
}
function _uuid(){ return Utilities.getUuid(); }
function _num(v){ var n = parseFloat(v); return isNaN(n)? null : n; }
function _int(v){ var n = parseInt(v,10); return isNaN(n)? null : n; }
function _lc(s){ return String(s||'').trim().toLowerCase(); }
function _ok(payload){
  var base = { ok:true };
  for (var k in payload){ if(Object.prototype.hasOwnProperty.call(payload,k)) base[k]=payload[k]; }
  return ContentService.createTextOutput(JSON.stringify(base)).setMimeType(ContentService.MimeType.JSON);
}
function _err(message, status, extra){
  var out = { ok:false, error:String(message) };
  if(extra){ for (var k in extra){ if(Object.prototype.hasOwnProperty.call(extra,k)) out[k]=extra[k]; } }
  return ContentService.createTextOutput(JSON.stringify(out)).setMimeType(ContentService.MimeType.JSON);
}

// 테이블 읽기(헤더 소문자화)
function _readTable(name){
  var sh = _getSheet(name); if(!sh) return [];
  var vals = sh.getDataRange().getValues();
  if(vals.length<2) return [];
  var headers = vals[0].map(function(h){ return _lc(h); });
  return vals.slice(1).filter(function(r){ return r.some(function(v){ return v!=='' && v!==null; }); }).map(function(row){
    var obj={}; headers.forEach(function(h,i){ obj[h]=row[i]; }); return obj;
  });
}
function _writeTable(name, headers, rows){
  var sh = _ensureSheet(name);
  sh.clearContents();
  sh.getRange(1,1,1,headers.length).setValues([headers]);
  if(rows && rows.length){
    var vals = rows.map(function(r){ return headers.map(function(h){ return r[h]; }); });
    sh.getRange(2,1,vals.length,headers.length).setValues(vals);
  }
}
function _appendRows(name, headers, rows){
  var sh = _ensureSheet(name);
  if(sh.getLastRow()===0){ sh.getRange(1,1,1,headers.length).setValues([headers]); }
  if(rows && rows.length){
    var vals = rows.map(function(r){ return headers.map(function(h){ return r[h]; }); });
    sh.getRange(sh.getLastRow()+1, 1, vals.length, headers.length).setValues(vals);
  }
}

// ------------------ Ensure / Migrations ------------------
function ensureSheets_(){
  ensureResultsHeader_();
  ensureTeamsHeader_();
  if(!_getSheet(CONF.TAB_TEAM_R)){
    _writeTable(CONF.TAB_TEAM_R, ['teamName','totalPoints','lastUpdated','prevPoints','deltaPoints','trend','city','group','rankMove'], []);
  }
  if(!_getSheet(CONF.TAB_TRHIST)){
    _writeTable(CONF.TAB_TRHIST, ['snapshotAt','teamName','totalPoints','group'], []);
  }
}
function ensureResultsHeader_(){
  var HEADERS = ['id','date','tourId','tourName','division','teams','stage','teamName','entrySize','createdAt','updatedAt'];
  var sh = _ensureSheet(CONF.TAB_RESULTS);
  if(sh.getLastRow()===0){
    sh.getRange(1,1,1,HEADERS.length).setValues([HEADERS]);
    return;
  }
  var vals = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  var have = vals.map(function(v){ return _lc(v); });
  var needRewrite = false;
  var normalized = HEADERS.map(function(h){
    var idx = have.indexOf(_lc(h));
    if(idx===-1){ needRewrite = true; }
    return h;
  });
  if(needRewrite){
    var data = sh.getRange(2,1,Math.max(0, sh.getLastRow()-1), sh.getLastColumn()).getValues();
    sh.clearContents();
    sh.getRange(1,1,1,normalized.length).setValues([normalized]);
    if(data.length){
      var oldMap = {};
      have.forEach(function(h,idx){ oldMap[h] = idx; });
      var remapped = data.map(function(row){
        return normalized.map(function(h){
          var i = oldMap[_lc(h)];
          return (i!=null && i>=0 && i<row.length) ? row[i] : '';
        });
      });
      sh.getRange(2,1,remapped.length,normalized.length).setValues(remapped);
    }
  }
  ensureIdsForResults_();
}
function ensureTeamsHeader_(){
  var HEADERS = ['teamName','city','group','logoUrl'];
  var sh = _ensureSheet(CONF.TAB_TEAMS);
  if(sh.getLastRow()===0){
    sh.getRange(1,1,1,HEADERS.length).setValues([HEADERS]);
  }else{
    // 헤더 유효성만 간단 체크
    var vals = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0].map(function(v){ return _lc(v); });
    var need = ['teamname','city','group','logourl'];
    var ok = true; for(var i=0;i<need.length;i++){ if(vals.indexOf(need[i])===-1){ ok=false; break; } }
    if(!ok){
      var data = sh.getRange(2,1,Math.max(0, sh.getLastRow()-1), sh.getLastColumn()).getValues();
      sh.clearContents();
      sh.getRange(1,1,1,HEADERS.length).setValues([HEADERS]);
      if(data.length){ sh.getRange(2,1,data.length,Math.min(HEADERS.length, data[0].length)).setValues(data); }
    }
  }
}
function ensureIdsForResults_(){
  var sh = _getSheet(CONF.TAB_RESULTS);
  if(!sh) return;
  var headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0].map(function(v){ return _lc(v); });
  function idx(name){ return headers.indexOf(_lc(name)); }
  var r = sh.getDataRange().getValues();
  if(r.length<2) return;
  var rows = r.slice(1);
  var now = _nowISO();

  var colId        = idx('id');
  var colDiv       = idx('division');
  var colCreatedAt = idx('createdat');
  var colUpdatedAt = idx('updatedat');

  var dirty = false;
  rows.forEach(function(row){
    if(!row[colId]){ row[colId] = _uuid(); dirty = true; }
    if(!row[colCreatedAt]){ row[colCreatedAt] = now; dirty = true; }
    row[colUpdatedAt] = now; dirty = true;

    if(row[colDiv]){
      var div = _normalizeDivision(row[colDiv]);
      if(div !== row[colDiv]){ row[colDiv] = div; dirty = true; }
    }
  });
  if(dirty){
    sh.getRange(2,1,rows.length,headers.length).setValues(rows);
  }
}

// ------------------ Settings ------------------
function _loadSettings(){
  var out = {
    basePoints : JSON.parse(JSON.stringify(DEFAULT_BASE_POINTS)),
    divWeights : JSON.parse(JSON.stringify(DEFAULT_DIV_WEIGHTS)),
    timeWeights: JSON.parse(JSON.stringify(DEFAULT_TIME_WEIGHTS)),
    sizeRules  : JSON.parse(JSON.stringify(DEFAULT_SIZE_RULES)),
  };
  var rows = _readTable(CONF.TAB_SETTINGS);
  rows.forEach(function(r){
    var key = _lc(r['key']);
    var v1  = String(r['value'] != null ? r['value'] : '').trim();
    var v2  = String(r['value2'] != null ? r['value2'] : '').trim();
    if(!key) return;

    if(key==='base_points' && v1){
      var n1 = _num(v2); if(n1!=null) out.basePoints[v1]=n1;
    }else if(key==='div_weight' && v1){
      var n2 = _num(v2); if(n2!=null) out.divWeights[v1]=n2;
    }else if(key==='time_weight' && v1){
      var n3 = _num(v2); if(n3!=null) out.timeWeights[v1.toUpperCase()]=n3;
    }else if(key==='size_rule' && v1){
      var w = _num(v2); if(w==null) return;
      var rule = parseSizeRule_(v1, w);
      if(rule) out.sizeRules.push(rule);
    }
  });
  return out;
}
function parseSizeRule_(expr, w){
  var s = String(expr).trim();
  if(/^>=\s*\d+$/.test(s)){ return {op:'>=', n:_int(s.replace('>=','')), w:w}; }
  if(/^<=\s*\d+$/.test(s)){ return {op:'<=', n:_int(s.replace('<=','')), w:w}; }
  if(/^=\s*\d+$/.test(s)) { return {op:'=',  n:_int(s.replace('=','')),  w:w}; }
  if(/^\d+\s*-\s*\d+$/.test(s)){
    var parts = s.split('-');
    var a = _int(parts[0]);
    var b = _int(parts[1]);
    return {op:'range', a:a, b:b, w:w};
  }
  return null;
}

// ------------------ Rule helpers ------------------
function _normalizeDivision(divStr){
  var raw = String(divStr||'').trim();
  if(!raw) return '';
  if(DEFAULT_DIV_WEIGHTS[raw]!=null) return raw; // 이미 D3~D7
  return NAME_TO_DIV[raw] || raw;
}
function _basePoints(stage, sets){
  var s = String(stage||'').trim();
  return (sets.basePoints[s]!=null) ? Number(sets.basePoints[s]) : 0;
}
function _divisionWeight(divStr, sets){
  var div = _normalizeDivision(divStr);
  return sets.divWeights[div]!=null ? Number(sets.divWeights[div]) : 1.0;
}
function _sizeWeight(nTeams, sets){
  var t = _int(nTeams);
  if(t==null) return 1.0;
  var rules = (sets.sizeRules && sets.sizeRules.length) ? sets.sizeRules : DEFAULT_SIZE_RULES;
  for(var i=0;i<rules.length;i++){
    var r = rules[i];
    if(r.op==='>=' && t>=r.n) return r.w;
    if(r.op==='range' && t>=r.a && t<=r.b) return r.w;
    if(r.op==='=' && t===r.n) return r.w;
    if(r.op==='<=' && t<=r.n) return r.w;
  }
  return 1.0;
}
function _timeWeight(dateStr, sets){
  var def0 = (sets.timeWeights && sets.timeWeights['Y-0']!=null) ? sets.timeWeights['Y-0'] : 1.0;
  var def1 = (sets.timeWeights && sets.timeWeights['Y-1']!=null) ? sets.timeWeights['Y-1'] : 0.5;
  var def2 = (sets.timeWeights && sets.timeWeights['Y-2']!=null) ? sets.timeWeights['Y-2'] : 0.25;
  var def3 = (sets.timeWeights && sets.timeWeights['Y-3']!=null) ? sets.timeWeights['Y-3'] : 0.0;

  if(!dateStr) return def0;
  var d = new Date(dateStr);
  if(isNaN(d))  return def0;
  var now = new Date();
  var diff = now.getFullYear() - d.getFullYear();
  if(diff<=0) return def0;
  if(diff===1) return def1;
  if(diff===2) return def2;
  return def3; // 소멸
}

// ------------------ Core: Recompute ------------------
function recomputeRanking_(){
  ensureSheets_();
  var lock = LockService.getScriptLock();
  lock.tryLock(3000);

  try{
    var sets = _loadSettings();
    var results = _readTable(CONF.TAB_RESULTS); // id/date/tourId/.../teamName...
    var teamPts = {};
    var teamLatest = {};
    // Teams 메타
    var teamMetaRows = _readTable(CONF.TAB_TEAMS);
    var metaByTeam = {};
    teamMetaRows.forEach(function(m){
      var name = String(m['teamname']||'').trim();
      if(!name) return;
      metaByTeam[name] = {
        city: String(m['city']||'').trim(),
        group: String(m['group']||'').trim(),  // 'd' | 'u' | ''
        logoUrl: String(m['logourl']||'').trim()
      };
    });

    // 누적
    results.forEach(function(r){
      var team = String(r['teamname']||'').trim();
      if(!team) return;

      var base  = _basePoints(r['stage'], sets); if(base<=0) return;
      var divW  = _divisionWeight(r['division'], sets);
      var sizeW = _sizeWeight(r['teams'], sets);
      var timeW = _timeWeight(r['date'], sets);

      var pts = base * divW * sizeW * timeW;

      teamPts[team] = (teamPts[team]||0) + pts;

      var d = _dateISO(r['date']);
      if(!teamLatest[team] || teamLatest[team] < d){ teamLatest[team] = d; }
    });

    // 이전 TeamRank 로딩(변동 계산용 prevPoints)
    var prevMap = {}; // team -> prevPoints
    _readTable(CONF.TAB_TEAM_R).forEach(function(row){
      var t = String(row['teamname']||'').trim();
      if(!t) return;
      prevMap[t] = _num(row['totalpoints']) || _num(row['prevpoints']) || 0;
    });

    // 현재 총점 rows + 메타 조인
    var rowsRaw = Object.keys(teamPts).map(function(name){
      var total = Math.round(teamPts[name]*100)/100;
      var prevPts = prevMap.hasOwnProperty(name) ? prevMap[name] : null;
      var delta = (prevPts==null) ? null : Math.round((total - prevPts)*100)/100;
      var trend = (delta==null) ? '' : (delta>0?'UP': (delta<0?'DOWN':'FLAT'));
      var meta = metaByTeam[name] || {city:'', group:'', logoUrl:''};
      return {
        teamName   : name,
        totalPoints: total,
        lastUpdated: teamLatest[name] || '',
        prevPoints : prevPts,
        deltaPoints: delta,
        trend      : trend,
        city       : meta.city,
        group      : meta.group || '',  // 'd' | 'u' | ''
        rankMove   : 0 // 나중에 계산
      };
    });

    // 그룹별 현재 랭크/이전 랭크 기반 rankMove 계산
    // prevRank: prevPoints 기준 그룹별 정렬 → 순위
    var prevByGroup = {};
    rowsRaw.forEach(function(r){
      var g = r.group || '';
      if(!prevByGroup[g]) prevByGroup[g] = [];
      var pp = (r.prevPoints==null) ? -Infinity : r.prevPoints;
      prevByGroup[g].push({ teamName:r.teamName, prevPoints:pp });
    });
    var prevRankMap = {}; // team -> prevRank
    for(var gk in prevByGroup){
      var arr = prevByGroup[gk];
      arr.sort(function(a,b){ return (b.prevPoints - a.prevPoints); });
      for(var i=0;i<arr.length;i++){
        var rank = (arr[i].prevPoints===-Infinity) ? null : (i+1);
        prevRankMap[arr[i].teamName] = rank;
      }
    }

    // currRank: totalPoints 기준 그룹별 정렬 → 순위
    var byGroup = {};
    rowsRaw.forEach(function(r){
      var g = r.group || '';
      if(!byGroup[g]) byGroup[g] = [];
      byGroup[g].push(r);
    });
    var rowsAll = []; // 최종 TeamRank 저장용(정렬은 전체 점수 내림차순 기본)
    for(var g in byGroup){
      var list = byGroup[g].slice().sort(function(a,b){ return b.totalPoints - a.totalPoints; });
      for(var i=0;i<list.length;i++){
        var currRank = i+1;
        var team = list[i].teamName;
        var prevRank = prevRankMap.hasOwnProperty(team) ? prevRankMap[team] : null;
        var move = (prevRank==null) ? 0 : (prevRank - currRank); // 양수: 순위 상승
        // list[i]의 rankMove 업데이트
        list[i].rankMove = move;
      }
      rowsAll = rowsAll.concat(list);
    }

    // TeamRank 저장(기존과 동일 스키마 + city, group, rankMove)
    rowsAll.sort(function(a,b){ return b.totalPoints - a.totalPoints; });
    _writeTable(CONF.TAB_TEAM_R,
      ['teamName','totalPoints','lastUpdated','prevPoints','deltaPoints','trend','city','group','rankMove'],
      rowsAll
    );

    // 히스토리 스냅샷 저장(그룹 포함)
    var snapAt = _nowISO();
    var histRows = rowsAll.map(function(r){
      return { snapshotAt: snapAt, teamName: r.teamName, totalPoints: r.totalPoints, group: r.group||'' };
    });
    _appendRows(CONF.TAB_TRHIST, ['snapshotAt','teamName','totalPoints','group'], histRows);

    // 캐시 저장(그룹별)
    saveLeaderboardCache_('');   // all
    saveLeaderboardCache_('d');  // 일반부
    saveLeaderboardCache_('u');  // 대학부

    return { recomputedAt: snapAt, teamCount: rowsAll.length };
  }finally{
    try{ lock.releaseLock(); }catch(e){}
  }
}

// ------------------ Cache (group-aware) ------------------
function leaderboardCacheKey_(group){
  return 'cache:team:' + String(group||'');
}
function saveLeaderboardCache_(group){
  var props = PropertiesService.getScriptProperties();
  var data = getLeaderboardRaw_(group);
  var payload = { savedAt: _nowISO(), data: data };
  props.setProperty(leaderboardCacheKey_(group), JSON.stringify(payload));
  return payload;
}
function getLeaderboardFromCache_(group){
  var props = PropertiesService.getScriptProperties();
  var raw = props.getProperty(leaderboardCacheKey_(group));
  if(!raw) return null;
  try{
    var obj = JSON.parse(raw);
    var saved = new Date(obj.savedAt).getTime();
    if(Date.now() - saved > CONF.CACHE_TTL_SEC*1000) return null;
    return obj.data;
  }catch(e){ return null; }
}
function getLeaderboard_(group){
  var cached = getLeaderboardFromCache_(group);
  if(cached) return cached;
  return saveLeaderboardCache_(group).data;
}
function getLeaderboardRaw_(group){
  // TeamRank에서 읽어 그룹 필터 후 랭크/정렬 부여
  var rows = _readTable(CONF.TAB_TEAM_R).map(function(r){
    return {
      teamName   : r['teamname'],
      totalPoints: _num(r['totalpoints']) || 0,
      lastUpdated: r['lastupdated']||'',
      prevPoints : (r['prevpoints']===''?null:_num(r['prevpoints'])),
      deltaPoints: (r['deltapoints']===''?null:_num(r['deltapoints'])),
      trend      : r['trend']||'',
      city       : r['city']||'',
      group      : r['group']||'',
      rankMove   : _num(r['rankmove']) || 0
    };
  });

  // 그룹 필터
  var g = String(group||'').trim();
  if(g==='d' || g==='u'){ rows = rows.filter(function(x){ return (String(x.group||'')===g); }); }

  // 정렬(점수 내림차순), 랭크 번호 부여(그룹 내 기준)
  rows.sort(function(a,b){ return b.totalPoints - a.totalPoints; });
  for(var i=0;i<rows.length;i++){ rows[i].rank = i+1; }

  return rows;
}

// ------------------ API Handlers ------------------
function handleGet_(p){
  var path = String(p.path||'').trim();

  if(path==='health'){
    return _ok({ version: VERSION, time:_nowISO() });
  }

  if(path==='leaderboard'){
    var group = (p.group||'').trim(); // '', 'd', 'u'
    var limit = _int(p.limit) || 0;
    var offset = _int(p.offset) || 0;

    var data = getLeaderboard_(group);
    var sliced = (limit && limit>0) ? data.slice(offset, offset+limit) : data;
    return _ok({ scope:'team', group: group||'', count: data.length, rows: sliced });
  }

  if(path==='results'){
    var div = (p.division||'').trim();
    var year= _int(p.year);
    var rows = _readTable(CONF.TAB_RESULTS).filter(function(r){
      if(div){
        var norm = _normalizeDivision(r['division']);
        if(norm!==div) return false;
      }
      if(year){
        var d = new Date(r['date']);
        if(!isNaN(d) && d.getFullYear()!==year) return false;
      }
      return true;
    });
    return _ok({ count: rows.length, rows: rows });
  }

  if(path==='recompute'){
    var res = recomputeRanking_();
    return _ok(res);
  }

  return _ok({ version: VERSION, hello:'BDR Ranking Backend (TeamOnly+Group)' });
}

function handlePost_(p, body){
  var path = String(p.path||'').trim();

  var json=null;
  try{ json = body ? JSON.parse(body) : {}; }catch(e){ return _err('invalid JSON body'); }

  if(path==='upsertResults'){
    var rows = Array.isArray(json.rows)? json.rows : [];
    if(!rows.length) return _err('rows required');

    ensureResultsHeader_();
    var sh = _getSheet(CONF.TAB_RESULTS);
    var headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0].map(function(h){ return String(h); });

    var now = _nowISO();
    var toAppend = [];
    rows.forEach(function(r){
      var div = _normalizeDivision(r.division);
      var rec = {
        id       : _uuid(),
        date     : r.date || '',
        tourId   : r.tourId || '',
        tourName : r.tourName || '',
        division : div,
        teams    : r.teams || '',
        stage    : r.stage || '',
        teamName : r.teamName || '',
        entrySize: r.entrySize || '',
        createdAt: now,
        updatedAt: now,
      };
      toAppend.push(rec);
    });

    _appendRows(CONF.TAB_RESULTS, headers, toAppend);
    if(json.recompute===true){ recomputeRanking_(); }
    return _ok({ upserted: toAppend.length });
  }

  if(path==='removeResults'){
    var ids = Array.isArray(json.ids)? json.ids : [];
    if(!ids.length) return _err('ids required');
    var sh2 = _getSheet(CONF.TAB_RESULTS); if(!sh2) return _err('Results sheet not found');
    var vals = sh2.getDataRange().getValues();
    var headers = vals[0].map(function(h){ return _lc(h); });
    var colId = headers.indexOf('id');
    if(colId===-1) return _err('Results.id header missing');
    var keep = [vals[0]];
    for(var i=1;i<vals.length;i++){
      var row = vals[i];
      if(ids.indexOf(row[colId])!==-1) continue;
      keep.push(row);
    }
    sh2.clearContents();
    sh2.getRange(1,1,keep.length,keep[0].length).setValues(keep);
    if(json.recompute===true){ recomputeRanking_(); }
    return _ok({ removed: ids.length });
  }

  if(path==='recompute'){
    var res2 = recomputeRanking_();
    return _ok(res2);
  }

  return _err('Unknown POST path: ' + path);
}

// ------------------ Entrypoints ------------------
function doGet(e){
  try{
    var p = (e && e.parameter) || {};
    return handleGet_(p);
  }catch(err){
    return _err(err && err.message ? err.message : String(err));
  }
}
function doPost(e){
  try{
    var p = (e && e.parameter) || {};
    var body = (e && e.postData && e.postData.contents) ? e.postData.contents : '';
    return handlePost_(p, body);
  }catch(err){
    return _err(err && err.message ? err.message : String(err));
  }
}

// ------------------ UI ------------------
function onOpen(){
  var ui = SpreadsheetApp.getUi();
  ui.createMenu('BDR Ranking')
    .addItem('재계산 실행', 'recompute')
    .addItem('헤더 정렬/보정', 'ensureResultsHeader_')
    .addItem('Teams 헤더 보정', 'ensureTeamsHeader_')
    .addItem('셀프테스트 시딩', 'selfTest_')
    .addToUi();
}
function recompute(){ // 에디터/메뉴용 공개 함수
  recomputeRanking_();
}

// ------------------ Self Test ------------------
function selfTest_(){
  ensureResultsHeader_();
  ensureTeamsHeader_();

  // Settings 샘플(필요 시)
  if(!_getSheet(CONF.TAB_SETTINGS)){
    _writeTable(CONF.TAB_SETTINGS, ['key','value','value2'], [
      {key:'BASE_POINTS', value:'우승', value2:100},
      {key:'BASE_POINTS', value:'준우승', value2:70},
      {key:'BASE_POINTS', value:'4강', value2:50},
      {key:'BASE_POINTS', value:'8강', value2:25},
      {key:'BASE_POINTS', value:'참가', value2:10},
      {key:'DIV_WEIGHT', value:'D3', value2:1},
      {key:'DIV_WEIGHT', value:'D4', value2:0.75},
      {key:'DIV_WEIGHT', value:'D5', value2:0.5},
      {key:'DIV_WEIGHT', value:'D6', value2:0.25},
      {key:'DIV_WEIGHT', value:'D7', value2:0.1},
      {key:'TIME_WEIGHT', value:'Y-0', value2:1},
      {key:'TIME_WEIGHT', value:'Y-1', value2:0.5},
      {key:'TIME_WEIGHT', value:'Y-2', value2:0.25},
      {key:'TIME_WEIGHT', value:'Y-3', value2:0},
      {key:'SIZE_RULE', value:'>=24', value2:1.5},
      {key:'SIZE_RULE', value:'13-23', value2:1.25},
      {key:'SIZE_RULE', value:'=12', value2:1.0},
      {key:'SIZE_RULE', value:'<=11', value2:0.5},
    ]);
  }

  // Teams 샘플
  var tSh = _getSheet(CONF.TAB_TEAMS);
  var tHeaders = tSh.getRange(1,1,1,tSh.getLastColumn()).getValues()[0].map(function(h){ return String(h); });
  var teamsSample = [
    {teamName:'STIZ', city:'경기 남양주', group:'d', logoUrl:''},
    {teamName:'BDR',  city:'서울',       group:'d', logoUrl:''},
    {teamName:'OWLS', city:'서울',       group:'u', logoUrl:''},
    {teamName:'SLOW', city:'인천',       group:'d', logoUrl:''},
  ];
  _appendRows(CONF.TAB_TEAMS, tHeaders, teamsSample);

  // Results 샘플
  var rSh = _getSheet(CONF.TAB_RESULTS);
  var rHeaders = rSh.getRange(1,1,1,rSh.getLastColumn()).getValues()[0].map(function(h){ return String(h); });
  var now = _nowISO(), today = _dateISO(new Date());
  var lastYear = _dateISO(new Date(new Date().setFullYear(new Date().getFullYear()-1)));
  var sample = [
    {id:_uuid(), date:today,    tourId:'T001', tourName:'9월리그', division:'D3', teams:24, stage:'우승',   teamName:'STIZ', entrySize:12, createdAt:now, updatedAt:now},
    {id:_uuid(), date:today,    tourId:'T001', tourName:'9월리그', division:'D3', teams:24, stage:'준우승', teamName:'BDR',  entrySize:10, createdAt:now, updatedAt:now},
    {id:_uuid(), date:today,    tourId:'T002', tourName:'주말컵',  division:'비기너스', teams:16, stage:'4강', teamName:'OWLS', entrySize:9, createdAt:now, updatedAt:now},
    {id:_uuid(), date:lastYear, tourId:'T003', tourName:'작년대회', division:'D4', teams:12, stage:'우승',   teamName:'SLOW', entrySize:10, createdAt:now, updatedAt:now},
  ];
  _appendRows(CONF.TAB_RESULTS, rHeaders, sample);

  var res = recomputeRanking_();
  Logger.log(JSON.stringify(res));
}
